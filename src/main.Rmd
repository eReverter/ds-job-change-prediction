---
title: "Assignment 2"
author: 'Enric Reverter & Gerard Pons'
date: "14/10/2021"
output:
  html_document:
    df_print: paged
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE, eval=F}
knitr::opts_chunk$set(echo = TRUE)
```

Assumptions:
- Sample from incomplete dataset.
- Everyone in this dataset is currently working.


### Required libraries

```{r}
## Data manipulation
require(tidyverse)
require(dplyr)
require(mice)
require(Hmisc)

## Statistics
library(lsr)
library(missMDA)
library(VIM)
library(chemometrics)
library(arules)
require(skimr)
require(car)

## Plots
require(ggplot2)
require(ggExtra)
require(ggthemes)
require(processx)
require(plotly)

require(cowplot)
require(gridExtra)

require(RColorBrewer)

theme_set(theme_bw())

## Set data path
setwd("..")
data_path = file.path(getwd(), "data")
plot_path = file.path(getwd(), "plots")
```


# Data Exploration

Load the dataset:
```{r}
df = read.csv(file.path(data_path, "jobs.csv"))
```

Sample from the original dataset:
```{r, eval=F}
data = read.csv(file.path(data_path, "aug_train.csv"))
set.seed(020198)
sample = sample(1:nrow(data), 5000)
df = data[sample,]
write.csv(df, file.path(data_path, "jobs.csv"), row.names = FALSE)
```

Skim over it:
```{r}
head(df)
summary(df)
str(df)
```

Convert data types to the proper format:
```{r}
df = df %>%
  mutate(across(where(is.character), ~ na_if(., ""))) %>%
  mutate(across(where(is.character), ~ as.factor(.)))

str(df)
skim(df)
```

Detail of factors:
```{r}
df %>%
  select(., where(is.factor)) %>%
  sapply(., table)

table(df$last_new_job)
```

Collapse categories for factor Experience:
- Entry-level: 0-2
- Junior-level: 3-4
- Mid-level: 5-6
- Senior-level: 7-10
- Chief: 11 - INF

Collapse categories for factor Company Size:
- Small
-Medium
-Large
```{r}
entry_level = c('<1','1','2')
junior_level = c('3','4')
mid_level = c('5','6')
senior_level = c('7','8','9','10')
chief_level = c('11','12','13','14','15','16','17','18','19','20','>20')

small_company = c('<10', '10/49')
medium_company = c('50-99','100-500','500-999')
large_company = c('1000-4999','5000-9999','10000+')

df = df %>% 
  mutate(across(where(is.factor), ~ as.character(.))) %>%
  mutate(experience = case_when(experience %in% entry_level ~ "Entry Level",
                                experience %in% junior_level ~ "Junior Level",
                                experience %in% mid_level ~ "Mid Level",
                                experience %in% senior_level ~ "Senior Level",
                                experience %in% chief_level ~ "Chief Level",
                                TRUE ~ experience)) %>%
  mutate(company_size = case_when(company_size %in% small_company ~ 'Small Company',
                                  company_size %in% medium_company ~ 'Medium Company',
                                  company_size %in% large_company ~ 'Large Company',
                                  TRUE ~ company_size)) %>%
  mutate(across(where(is.character), ~ as.factor(.)))


```

### Missing Values

For NA's:
- If education level is null and they are in university -> highschool
- If major_discipline != NA then education_level graduate at least
- If graduated/masters then impute major discipline, else no major discipline
- If experience is NA and last_new_job, company_type, company_size != 0 then impute, else delete
- If gender is missing impute with other
- If company information is missing impute with unknown.

```{r}
df = df %>%
  mutate()

aux = df %>%
  mutate(across(where(is.factor), ~ as.character(.))) %>%
  mutate(education_level = case_when(is.na(education_level) & enrolled_university %in% ~ )))
```

```{r}
count_na = function(x) sum(is.na(x))

aux = df %>%
  mutate(across(matches("company"), ~ as.character(.))) %>%
  mutate(across(matches("company"), ~ replace_na(., "NA"))) %>%
  mutate(across(matches("company"), ~ as.factor(.))) %>%
  mutate(count_na = apply(., 1, count_na))

summary(aux$count_na)
```

Let's suppose we drop the >2 NA's different from company:
```{r}
aux = aux %>%
  filter(., count_na < 3)

skim(aux)
```

Gender is still an issue.

Drop all NA's:
```{r}
aux = aux %>%
  drop_na()
```

Group data by all:
```{r}
grouped = aux %>%
  group_by(gender, relevent_experience, enrolled_university, education_level, major_discipline, experience, company_size, company_type, last_new_job, target) %>%
  summarise(., count = n()) %>%
  as.data.frame()

dim(grouped)
head(grouped)
A = 'HOLA'
```

- City index should be discretized, same goes for training hours.
- Not many outliers can be detected since there is no numeric data (almost). 

### Outlier treatment

### Imbalanced dataset -> Proportions on grouped data

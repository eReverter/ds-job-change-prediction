---
title: "Assignment 2"
author: 'Enric Reverter & Gerard Pons'
date: "14/10/2021"
output:
  html_document:
    df_print: paged
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE, eval=F}
knitr::opts_chunk$set(echo = TRUE)
```

Assumptions:
- Sample from incomplete dataset.
- Everyone in this dataset is currently working.


### Required libraries

```{r, eval=F}
## Data manipulation
library(tidyverse)
library(dplyr)
library(mice)
library(Hmisc)
## Statistics
library(lsr)
library(missMDA)
library(VIM)
library(chemometrics)
library(arules)
library(skimr)
library(car)
library(FactoMineR)
library(factoextra)
library(effects)
## Plots
library(ggplot2)
library(ggExtra)
library(ggthemes)
library(processx)
library(plotly)
library(cowplot)
library(gridExtra)
library(RColorBrewer)
theme_set(theme_bw())
## Set data path
setwd("..")
data_path = file.path(getwd(), "data")
plot_path = file.path(getwd(), "plots")
```


# Data Exploration

Load the dataset:
```{r}
df = read.csv(file.path(data_path, "jobs.csv"))
```

Sample from the original dataset:
```{r, eval=F}
data = read.csv(file.path(data_path, "aug_train.csv"))
set.seed(020198)
sample = sample(1:nrow(data), 5000)
df = data[sample,]
write.csv(df, file.path(data_path, "jobs.csv"), row.names = FALSE)
```

Skim over it:
```{r, eval=F}
head(df)
summary(df)
str(df)
```

Convert data types to the proper format:
```{r}
df = df %>%
  mutate(across(where(is.character), ~ na_if(., ""))) %>%
  mutate(across(where(is.character) | matches("target"), ~ as.factor(.)))
```

Detail of factors:
```{r, eval=F}
df %>%
  select(., where(is.factor)) %>%
  sapply(., table)
table(df$last_new_job)
```

Collapse categories for factor Experience:
- Entry-level: 0-2
- Junior-level: 3-4
- Mid-level: 5-6
- Senior-level: 7-10
- Chief: 11 - INF

Collapse categories for factor Company Size:
- Small
-Medium
-Large

```{r}
entry_level = c('<1','1','2')
junior_level = c('3','4')
mid_level = c('5','6')
senior_level = c('7','8','9','10')
chief_level = c('11','12','13','14','15','16','17','18','19','20','>20')
small_company = c('<10', '10/49')
medium_company = c('50-99','100-500','500-999')
large_company = c('1000-4999','5000-9999','10000+')
df = df %>% 
  mutate(across(where(is.factor), ~ as.character(.))) %>%
  mutate(experience = case_when(experience %in% entry_level ~ "Entry Level",
                                experience %in% junior_level ~ "Junior Level",
                                experience %in% mid_level ~ "Mid Level",
                                experience %in% senior_level ~ "Senior Level",
                                experience %in% chief_level ~ "Chief Level",
                                TRUE ~ experience)) %>%
  mutate(company_size = case_when(company_size %in% small_company ~ 'Small Company',
                                  company_size %in% medium_company ~ 'Medium Company',
                                  company_size %in% large_company ~ 'Large Company',
                                  TRUE ~ company_size)) %>%
  mutate(across(where(is.character), ~ as.factor(.)))
```

### Missing Values

Count number of missing values across each row:
```{r, eval=F}
count_na = function(x) {sum(is.na(x))}
df = df %>%
  mutate(across(matches("company"), ~ as.character(.))) %>%
  mutate(across(matches("company"), ~ na_if(., "NA"))) %>%
  mutate(across(matches("company"), ~ as.factor(.))) %>%
  mutate(count_na = apply(., 1, count_na))
summary(df$count_na)
boxplot(df$count_na)
table(df$count_na)
df = df %>%
  filter(., count_na < 5) %>%
  select(., -c("count_na"))
```

For NA's:
- If education level is null and they are in university -> highschool ok
- If major_discipline != NA then education_level graduate at least ok
- If graduated/masters then impute major discipline, else no major discipline ok
- If experience is NA and last_new_job, company_type, company_size != 0 then impute, else delete
- If gender is missing impute with other
- If company information is missing impute with unknown.

Logical imputation:
```{r}
df = df %>%
  mutate(f.enrolled = case_when(enrolled_university == "no_enrollment" ~ "No",
                                !is.na(enrolled_university) ~ "Yes"))
df = df %>%
  # Convert factors to strings in order to impute them
  mutate(across(where(is.factor), ~ as.character(.))) %>%
  
  # Impute education level as mentioned above
  mutate(education_level = case_when(is.na(education_level) & f.enrolled == "Yes" ~ "High School",
                                     !is.na(major_discipline) & !(education_level %in% c("Graduate", "Masters", "Phd")) ~ "Graduate",
                                     TRUE ~ education_level)) %>%
  
  # Impute major_discipline as mentioned above
  mutate(major_discipline = case_when(is.na(major_discipline) & !(education_level %in% c("Graduate", "Masters", "Phd")) ~ "No Major",
                                      is.na(major_discipline) & education_level %in% c("Graduate", "Masters", "Phd") ~ "Other",
                                      TRUE ~ major_discipline)) %>%
  
  # Impute enrolled_university
  mutate(enrolled_university = case_when(is.na(enrolled_university) & education_level %in% c("Masters", "Phd") ~ "no_enrollment",
                                         TRUE ~ enrolled_university)) %>%
  
  # Impute experience
  mutate(experience = case_when(is.na(experience) & (is.na(last_new_job) & is.na(company_size) & is.na(company_type)) ~ "Entry Level",
                                TRUE ~ experience)) %>%
  
  # Impute gender
  mutate(gender = case_when(is.na(gender) ~ "Other",
                            TRUE ~ gender)) %>%
  
  # Impute company
  mutate(company_size = case_when(is.na(company_size) ~ "Unknown",
                                  TRUE ~ company_size)) %>%
  mutate(company_type = case_when(is.na(company_type) ~ "Other",
                                  TRUE ~ company_type)) %>%
  
  # Convert back to factors    
  mutate(across(where(is.character), ~ as.factor(.))) %>%
  
  # Drop unused columns
  select(., -c("f.enrolled"))
```

Class frequency:
```{r}
table(df$gender)
table(df$relevent_experience)
table(df$education_level) # Collapse PhD and Primary School?
table(df$major_discipline) # Collapse major_discipline?
table(df$experience)
table(df$company_type) # It is not other, it is unknown, what should we do
table(df$company_size) # Ask Lidia
table(df$last_new_job)
table(df$enrolled_university)
```

Remaining NA's depicted below. See how at most we have 2% of missing values on last_new_job:
```{r}
colSums(is.na(df))
```

Indicator of rows which still have NA's:
```{r}
imputed_indicator = function(x) {if(count_na(x)>0) {return(TRUE)} else {return(FALSE)}}

df = df %>%
  mutate(imputed = apply(., 1, imputed_indicator))
```

## FAMD IMPUTATION

Impute with FAMD method:
```{r}
res.famd = imputeFAMD(select(df, -c("target", "city", "enrollee_id", "imputed")))
```

Compare class frequency after imputation:
```{r}
prop.table(table(df$education_level))
prop.table(table(res.famd$completeObs$education_level))
prop.table(table(df$last_new_job))
prop.table(table(res.famd$completeObs$last_new_job))
prop.table(table(df$enrolled_university))
prop.table(table(res.famd$completeObs$enrolled_university))
summary(df$training_hours)
```

Store complete dataset:
```{r}
df = data.frame(res.famd$completeObs, select(df, c("target", "city", "enrollee_id", "imputed")))
```

Write it:
```{r, eval=F}
write.csv(df, file.path(data_path, "jobs_compl.csv"), row.names = FALSE)
```

### Outlier treatment

Look at univariant outliers:
```{r, eval=F}
extreme_out = quantile(df$training_hours)[[4]]+3*IQR(df$training_hours)
ggplot(data = df, aes(x="", y=training_hours)) +
  geom_boxplot(width=0.5) +
  geom_hline(yintercept = extreme_out, color="red") +
  scale_y_continuous(labels=scales::comma) 
labs(title='Boxplot Training Hours',
     y="Training Hours") +
  # Do not show x axis
  theme(axis.text.x=element_blank(), axis.ticks.x = element_blank(), axis.line.x = element_blank(), axis.title.x=element_blank())
num_outliers = df %>%
  filter(., training_hours > extreme_out) %>%
  nrow()
num_outliers
outliers = df %>%
  filter(., training_hours > extreme_out)
prop.table(table(df$gender))
prop.table(table(outliers$gender))
prop.table(table(df$relevent_experience))
prop.table(table(outliers$relevent_experience))
prop.table(table(df$enrolled_university))
prop.table(table(outliers$enrolled_university))
prop.table(table(df$education_level))
prop.table(table(outliers$education_level))
prop.table(table(df$major_discipline))
prop.table(table(outliers$major_discipline))
prop.table(table(df$last_new_job))
prop.table(table(outliers$last_new_job))
```

```{r, eval=F}
summary(df$training_hours)
boxplot(df$training_hours)
```

# Modelization

```{r}
cat = FactoMineR::catdes(df[,-c(13:15)], 12)
cat$test.chi2
cat$quanti.var
cat$category
cat$quanti
```

INSPECT THE NULL MODEL
```{r}
df = select(df, -c("city", "enrollee_id"))
m0 = glm(target ~ 1, data=df, family=binomial)
summary(m0)
```

INSPACT THE NUMERICAL VARIABLES
```{r}
m1 = glm(target ~ training_hours, data=df, family=binomial)
m2 = glm(target ~ city_development_index, data=df, family=binomial)

m3 = glm(target ~ training_hours+city_development_index, data=df, family=binomial)
m4 = glm(target ~ training_hours*city_development_index, data=df, family=binomial)
```

```{r}
# Gross effects
anova(m0,m1,test="Chisq")
anova(m0,m2,test="Chisq")

# Net effects
anova(m1,m3,test="Chisq")
anova(m2,m3,test="Chisq")

# Interaction effects
anova(m3,m4,test="Chisq")
```

The marginal model plots suggest a  ^(-1/2) transformation over the city development variable
```{r}
marginalModelPlots(m3)
```

As it can be seen, the transformation increases the fitness, and it results in a better model following AIC criterion. 
```{r}
m5 = glm(target ~ training_hours+I(city_development_index^-0.5), data=df, family=binomial)
marginalModelPlots(m5)
AIC(m3,m5)
```

Now, the additive effect of variables is explored by using the step function with AIC, to be more permissive.
```{r}
maux = glm(target ~ I(city_development_index^-0.5) + ., data=df, family=binomial)
m6 = step(maux)
vif(m6)
```

```{r}
anova(m5,m6,test="Chisq")
AIC(m5,m6)
```

To check for interactions, we use the step function again, but now with BIC criterion, to be more restrictive.

```{r}
m7 = step(maux , scope = . ~ .^2, k = log(nrow(df)))
```

As we can obviously see, the results of the additive terms with BIC are a set of the ones with AIC, an one interaction is preserved. The merged model is as follows:
```{r}
m8 = glm(target ~ I(city_development_index^(-0.5))*company_size + relevent_experience + 
    education_level + experience + company_type + 
    last_new_job + training_hours, family = "binomial", data = df)

anova(m6,m8,test='Chisq')
anova(m7,m8,test='Chisq')
AIC(m6,m7,m8)
```

```{r}
interaction.plot(df$company_size, df$education_level, as.numeric(df$target))
```

```{r}
# SUMMARY OF USEFUL PLOTS
avPlots(m1)
par(mfrow=c(2,2))
plot(m1) 
par(mfrow=c(1,1))
plot(allEffects(m7),ask=FALSE)
residualPlots(m7)
crPlots(m1)
marginalModelPlots(m1)
outlierTest(m1)
influencePlot(m7)
```

```{r}
eff <- allEffects(m7) 

plot(eff, main= FALSE,rug=FALSE,colors=1, band.colors=3, col=1, 
     xlim=c(0, 20), ylim = qlogis(c(0.1, 0.6))) # also log(c(.1, .6)/c(.6, .1))
```

